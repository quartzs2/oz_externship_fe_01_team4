name: Discord Notifications

on:
  pull_request:
    types: [opened, review_requested, closed]
  pull_request_review:
    types: [submitted]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      # GitHub ìœ ì €ëª…ì„ Discord ìœ ì € IDë¡œ ë§¤í•‘
      - name: Map GitHub to Discord users
        id: user-mapping
        run: |
          case "${{ github.event.requested_reviewer.login || github.actor }}" in
            "chen4023")
              echo "discord_mention=<@683563560063991848>" >> $GITHUB_OUTPUT
              ;;
            "devjaesung")
              echo "discord_mention=<@1344112571330072626>" >> $GITHUB_OUTPUT
              ;;
            "quartzs2")
              echo "discord_mention=<@280589926477856778>" >> $GITHUB_OUTPUT
              ;;
            *)
              echo "discord_mention=${{ github.event.requested_reviewer.login || github.actor }}" >> $GITHUB_OUTPUT
              ;;
          esac

      # PR ìƒì„± ì•Œë¦¼
      - name: PR ìƒì„± ì•Œë¦¼
        if: github.event.action == 'opened'
        run: |
          curl -H "Content-Type: application/json" \
               -X POST \
               -d '{
                 "embeds": [{
                   "title": "ğŸ†• ìƒˆë¡œìš´ PRì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!",
                   "description": "[${{ github.event.pull_request.title }}](${{ github.event.pull_request.html_url }})",
                   "color": 3447003,
                   "fields": [
                     {
                       "name": "ğŸ‘¤ ì‘ì„±ì",
                       "value": "${{ github.event.pull_request.user.login }}",
                       "inline": true
                     },
                     {
                       "name": "ğŸŒ¿ ë¸Œëœì¹˜",
                       "value": "`${{ github.event.pull_request.head.ref }}` â†’ `${{ github.event.pull_request.base.ref }}`",
                       "inline": true
                     },
                     {
                       "name": "ğŸ“Š ë³€ê²½ì‚¬í•­",
                       "value": "+${{ github.event.pull_request.additions }} -${{ github.event.pull_request.deletions }}",
                       "inline": true
                     }
                   ],
                   "timestamp": "${{ github.event.pull_request.created_at }}"
                 }]
               }' \
               ${{ secrets.DISCORD_WEBHOOK_URL }}

      # ë¦¬ë·°ì–´ ë©˜ì…˜
      - name: ë¦¬ë·°ì–´ ë©˜ì…˜
        if: github.event.action == 'review_requested'
        run: |
          curl -H "Content-Type: application/json" \
               -X POST \
               -d '{
                 "content": "ğŸ” **ë¦¬ë·° ìš”ì²­ì´ ë„ì°©í–ˆìŠµë‹ˆë‹¤!** ${{ steps.user-mapping.outputs.discord_mention }}",
                 "embeds": [{
                   "title": "ë¦¬ë·°ë¥¼ ë¶€íƒë“œë¦½ë‹ˆë‹¤! ğŸ‘€",
                   "description": "[${{ github.event.pull_request.title }}](${{ github.event.pull_request.html_url }})",
                   "color": 16776960,
                   "fields": [
                     {
                       "name": "ğŸ‘¤ PR ì‘ì„±ì",
                       "value": "${{ github.event.pull_request.user.login }}",
                       "inline": true
                     },
                     {
                       "name": "ğŸ‘€ ë¦¬ë·°ì–´",
                       "value": "${{ github.event.requested_reviewer.login }}",
                       "inline": true
                     },
                     {
                       "name": "ğŸ“‹ ì„¤ëª…",
                       "value": "${{ github.event.pull_request.body || 'ì„¤ëª…ì´ ì—†ìŠµë‹ˆë‹¤.' }}",
                       "inline": false
                     }
                   ]
                 }]
               }' \
               ${{ secrets.DISCORD_WEBHOOK_URL }}

      # PR ë³‘í•©/ë‹«í˜ ì•Œë¦¼
      - name: PR ì™„ë£Œ ì•Œë¦¼
        if: github.event.action == 'closed'
        run: |
          if [ "${{ github.event.pull_request.merged }}" == "true" ]; then
            STATUS="âœ… ë³‘í•© ì™„ë£Œ!"
            COLOR="65280"
            EMOJI="ğŸ‰"
          else
            STATUS="âŒ PR ë‹«í˜"
            COLOR="16711680"
            EMOJI="ğŸš«"
          fi

          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{
                 \"embeds\": [{
                   \"title\": \"$EMOJI $STATUS\",
                   \"description\": \"[${{ github.event.pull_request.title }}](${{ github.event.pull_request.html_url }})\",
                   \"color\": $COLOR,
                   \"fields\": [
                     {
                       \"name\": \"ğŸ‘¤ ì‘ì„±ì\",
                       \"value\": \"${{ github.event.pull_request.user.login }}\",
                       \"inline\": true
                     },
                     {
                       \"name\": \"ğŸŒ¿ ë¸Œëœì¹˜\",
                       \"value\": \"\`${{ github.event.pull_request.head.ref }}\` â†’ \`${{ github.event.pull_request.base.ref }}\`\",
                       \"inline\": true
                     }
                   ]
                 }]
               }" \
               ${{ secrets.DISCORD_WEBHOOK_URL }}

      # ë¦¬ë·° ì™„ë£Œ ì•Œë¦¼
      - name: ë¦¬ë·° ì™„ë£Œ ì•Œë¦¼
        if: github.event.review.state == 'approved'
        run: |
          curl -H "Content-Type: application/json" \
               -X POST \
               -d '{
                 "embeds": [{
                   "title": "âœ… ë¦¬ë·° ìŠ¹ì¸ ì™„ë£Œ!",
                   "description": "[${{ github.event.pull_request.title }}](${{ github.event.pull_request.html_url }})",
                   "color": 65280,
                   "fields": [
                     {
                       "name": "ğŸ‘€ ë¦¬ë·°ì–´",
                       "value": "${{ github.event.review.user.login }}",
                       "inline": true
                     },
                     {
                       "name": "ğŸ’¬ ë¦¬ë·° ë‚´ìš©",
                       "value": "${{ github.event.review.body || 'ì½”ë©˜íŠ¸ ì—†ìŒ' }}",
                       "inline": false
                     }
                   ],
                   "footer": {
                     "text": "ì´ì œ ë³‘í•©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤! ğŸš€"
                   }
                 }]
               }' \
               ${{ secrets.DISCORD_WEBHOOK_URL }}

      # ë³€ê²½ ì‚¬í•­ ìš”ì²­ ì•Œë¦¼
      - name: ë³€ê²½ ìš”ì²­ ì•Œë¦¼
        if: github.event.review.state == 'changes_requested'
        run: |
          # PR ì‘ì„±ì Discord ID ë§¤í•‘
          case "${{ github.event.pull_request.user.login }}" in
            "chen4023")
              AUTHOR_MENTION="<@683563560063991848>"
              ;;
            "devjaesung")
              AUTHOR_MENTION="<@1344112571330072626>"
              ;;
            "quartzs2")
              AUTHOR_MENTION="<@280589926477856778>"
              ;;
            *)
              AUTHOR_MENTION="${{ github.event.pull_request.user.login }}"
              ;;
          esac

          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{
                 \"content\": \"ğŸ”„ **ë³€ê²½ì‚¬í•­ì´ ìš”ì²­ë˜ì—ˆìŠµë‹ˆë‹¤!** $AUTHOR_MENTION\",
                 \"embeds\": [{
                   \"title\": \"â— ìˆ˜ì •ì´ í•„ìš”í•©ë‹ˆë‹¤\",
                   \"description\": \"[${{ github.event.pull_request.title }}](${{ github.event.pull_request.html_url }})\",
                   \"color\": 16776960,
                   \"fields\": [
                     {
                       \"name\": \"ğŸ‘€ ë¦¬ë·°ì–´\",
                       \"value\": \"${{ github.event.review.user.login }}\",
                       \"inline\": true
                     },
                     {
                       \"name\": \"ğŸ“ ìš”ì²­ì‚¬í•­\",
                       \"value\": \"${{ github.event.review.body || 'ìì„¸í•œ ë‚´ìš©ì€ PRì„ í™•ì¸í•´ì£¼ì„¸ìš”.' }}\",
                       \"inline\": false
                     }
                   ]
                 }]
               }" \
               ${{ secrets.DISCORD_WEBHOOK_URL }}
